<!DOCTYPE html >
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>FruitMap Fruit Tree Mapper</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAS6leX7t066ObvmuqZzbfOnyiVO-t1xy4"
            type="text/javascript"></script>
	<script type="text/javascript">
	var infowindow;
	var marker;
  var gmarkers = [];
	
  function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(load);
    } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
	}
		
    var customIcons = {
      cauliflower: {
        icon: 'images/cauliflower-icon.png'
      },
      orange: {
        icon: 'images/orange-icon.png'
      },
	  apple: {
        icon: 'images/apple-icon.png'
      },
	  lemon: {
        icon: 'images/lemon-icon.png'
      },
	  lime: {
        icon: 'images/lime-icon.png'
      },
	  blackberry: {
        icon: 'images/blackberry-icon.png'
      },
	  avocado: {
        icon: 'images/avocado-icon.png'
      },
	  plum: {
        icon: 'images/plum-icon.png'
      },
	  peach: {
        icon: 'images/peach-icon.png'
      },
	  fig: {
        icon: 'images/fig-icon.png'
      },
	  mandarin: {
        icon: 'images/mandarin-icon.png'
      }
//	  blackberry: {
//        icon: 'images/blackberry-icon.png'
//      }	  
    };

    function load(position) {
	  console.log(position);
    
    console.log("Loading position...");
    console.log(position);
	  var myLatLng = {lat: position.coords.latitude, lng: position.coords.longitude};

      function CenterControl(controlDiv, map) {

        // Set CSS for the control border.
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.margin = '10px';
//        controlUI.style.marginBottom = '22px';
        controlUI.style.textAlign = 'center';
        controlUI.title = 'Click to recenter the map';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '12px';
        controlText.style.lineHeight = '20px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = 'Center map';
        controlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.
        controlUI.addEventListener('click', function() {
          map.setCenter(myLatLng);
        });

      }



    console.log("Create new map...");
      var map = new google.maps.Map(document.getElementById("map"), {
        center: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
        zoom: 18,
        mapTypeId: 'satellite',
	    disableDefaultUI: true,
		zoomControl: true,
		mapTypeControl: true,
		scaleControl: false,
		streetViewControl: false,
		rotateControl: false
      });
	  var html = "<table>" +
		"<tr><td>Name:</td> <td><input type='text' id='name'/> </td> </tr>" +
		"<tr><td>Address:</td> <td><input type='text' id='address'/></td> </tr>" +
		"<tr><td>Type:</td> <td><select id='type'>" +
		"<option value='apple' SELECTED>apple</option>" +
		"<option value='blackberry'>blackberry</option>" +
		"<option value='lemon'>lemon</option>" +
		"<option value='lime'>lime</option>" +
		"<option value='orange'>orange</option>" +
		"<option value='cauliflower'>cauliflower</option>" +
		"<option value='avocado'>avocado</option>" +	
		"<option value='plum'>plum</option>" +		
		"<option value='peach'>peach</option>" +		
		"<option value='fig'>fig</option>" +			
		"<option value='mandarin'>mandarin</option>" +			
		 "</select> </td></tr>" +
		 "<tr><td></td><td><input type='button' value='Save & Close' onclick='saveData()'/></td><td><input type='button' value='Delete' onclick='deleteData()'/></td></tr>";
    infowindow = new google.maps.InfoWindow({
     content: html
    });

	  map.setTilt(0);
	
        var centerControlDiv = document.createElement('div');
        var centerControl = new CenterControl(centerControlDiv, map);

        centerControlDiv.index = 1;
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(centerControlDiv);
  
  console.log("Set marker for current location at " + position.coords.latitude + ", " + position.coords.longitude);  
  var marker = new google.maps.Marker({
		position: myLatLng,
		map: map,
		title: 'Current location',
		label: '',
		icon: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png'
	});
//    bindInfoWindow(marker, map, infoWindow, "<b>Current location</b><br/>" + lat + ", " + lng);
	  console.log(map);
    
//  gmarkers.push(marker);
	  	  
//    console.log("Bind info window");
//    bindInfoWindow(marker, map, infoWindow, html); 
    
//	    // This event listener calls addMarker() when the map is clicked.
//  google.maps.event.addListener(map, 'click', function(event) {
//           infowindow.open(map, marker);
//    addMarker(event.latLng, map);
//  });

    google.maps.event.addListener(map, "click", function(event) {
        marker = new google.maps.Marker({
          position: event.latLng,
          map: map,
          icon: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png'
        });
        google.maps.event.addListener(marker, "click", function() {
          infowindow.open(map, marker);
        });
        console.log(marker.position.lat() + ", " + marker.position.lng());
        gmarkers.push(marker);
//        console.log("Print gmarkers array");
//        console.log(gmarkers);
    });
    
//  gmarkers.push(marker);
//  console.log(gmarkers);

}
        function timeDelay() {
		  window.setTimeout(redirectToMap,1000);
		}

		function redirectToMap() {
		  window.location = "index.html";
		}


    function saveData() {
      var name = escape(document.getElementById("name").value);
      var address = escape(document.getElementById("address").value);
      var type = document.getElementById("type").value;

//      console.log(gmarkers);
     var lastValue = gmarkers.length - 1;
      console.log("Save last marker");
//      gmarkers[lastValue].position();



      var latlng = gmarkers[lastValue].getPosition();

      var url = "addrecord.php?name=" + name + "&address=" + address +
                "&type=" + type + "&lat=" + latlng.lat() + "&lng=" + latlng.lng();

      
      downloadUrl(url, function(data, responseCode) {
        if (responseCode == 200) {
          infowindow.close();
          document.getElementById("message").innerHTML = "Location added.";
		  timeDelay();
		  }
      });
    }
    
    function deleteData() {
      var lastValue = gmarkers.length - 1;
      console.log("Delete last marker");
      gmarkers[lastValue].setMap(null);
    }

	    function downloadUrl(url, callback) {
      var request = window.ActiveXObject ?
          new ActiveXObject('Microsoft.XMLHTTP') :
          new XMLHttpRequest;

      request.onreadystatechange = function() {
        if (request.readyState == 4) {
          request.onreadystatechange = doNothing;
          callback(request.responseText, request.status);
        }
      };

      request.open('GET', url, true);
      request.send(null);
    }  
  
    function doNothing() {}

  </script>

  </head>

  <body onload="getLocation()">
	<div style="width:500px; height:500px" id="map"></div>
    <button onclick="window.location.href='index.html'">Go back</button>
	<div id="message"></div>
  </body>

</html>