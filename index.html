<!DOCTYPE html >
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>FruitMap Fruit Tree Mapper</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAS6leX7t066ObvmuqZzbfOnyiVO-t1xy4"
            type="text/javascript"></script>
            
          
	<script type="text/javascript">

 function toTitleCase(str)
  {
      return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
  }   

	var deleteRecord;

	function getLocation() {

    if (navigator.geolocation) {
       // console.log("Running getCurrentPosition");
      if(navigator.geolocation.getCurrentPosition(load)) {  
        // console.log("Location shared");
      }
      else {
        // console.log("Location not shared");
      }
    } else {
        // console.log("Geolocation function not supported");
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
	}

    var customIcons = {
     orange: {
        icon: 'images/orange-icon.png'
      },
	  apple: {
        icon: 'images/apple-icon.png'
      },
	  lemon: {
        icon: 'images/lemon-icon.png'
      },
	  lime: {
        icon: 'images/lime-icon.png'
      },
	  blackberry: {
        icon: 'images/blackberry-icon.png'
      },
	  avocado: {
        icon: 'images/avocado-icon.png'
      },
	  plum: {
        icon: 'images/plum-icon.png'
      },
	  peach: {
        icon: 'images/peach-icon.png'
      },
	  fig: {
        icon: 'images/fig-icon.png'
      },
	  mandarin: {
        icon: 'images/mandarin-icon.png'
      },
    apricot: {
        icon: 'images/apricot-icon.png'
      },
    banana: {
        icon: 'images/banana-icon.png'
      },
    blueberry: {
        icon: 'images/blueberry-icon.png'
      },
    cherry: {
        icon: 'images/cherry-icon.png'
      },
    grape: {
        icon: 'images/grape-icon.png'
      },
    grapefruit: {
        icon: 'images/grapefruit-icon.png'
      },
    guava: {
        icon: 'images/guava-icon.png'
      },
    kiwi: {
        icon: 'images/kiwi-icon.png'
      },
    mango: {
        icon: 'images/mango-icon.png'
      },
    olive: {
        icon: 'images/olive-icon.png'
      },
    pear: {
        icon: 'images/pear-icon.png'
      },
    raspberry: {
        icon: 'images/raspberry-icon.png'
      },
    strawberry: {
        icon: 'images/strawberry-icon.png'
      },
    pomegranite: {
        icon: 'images/pomegranite-icon.png'
      }
    };

    var centerMeIcon = 'images/findme.png';
    var mapFruitIcon = 'images/apple-icon.png';
    
    function load(position) {
    // console.log("Loading position...");
	  // console.log(position);
	  var myLatLng = {lat: position.coords.latitude, lng: position.coords.longitude};






      /**
       * The CenterControl adds a control to the map that recenters the map on
       * Chicago.
       * This constructor takes the control DIV as an argument.
       * @constructor
       */
      function CenterControl(controlDiv, map) {

        // Set CSS for the control border.
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.margin = '10px';
//        controlUI.style.marginBottom = '22px';
        controlUI.style.textAlign = 'center';
        controlUI.title = 'Click to recenter the map';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '12px';
        controlText.style.lineHeight = '30px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = "<img style='vertical-align:middle' src='" + centerMeIcon + "'>   Center map";
        controlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.
        controlUI.addEventListener('click', function() {
          map.setCenter(myLatLng);
        });

      }

      function MapControl(controlDiv, map) {

        // Set CSS for the control border.
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.margin = '10px';
//        controlUI.style.marginBottom = '22px';
        controlUI.style.textAlign = 'center';
        controlUI.title = 'Click to map some fruit';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '12px';
        controlText.style.lineHeight = '30px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
//        controlText.style.margin = '2px';
//        controlText.style.verticalAlign = 'middle';
        controlText.innerHTML = "<img style='vertical-align:middle' src='" + mapFruitIcon + "'>   Map fruit";
        controlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.
        controlUI.addEventListener('click', function() {
            location.href = "add.html";
//          map.setCenter(myLatLng);
        });

      }

    var lat = parseFloat(position.coords.latitude).toFixed(3);
    var lng = parseFloat(position.coords.longitude).toFixed(3);



    // console.log("Create new map...");
      var map = new google.maps.Map(document.getElementById("map"), {
        center: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
        zoom: 20,
        mapTypeId: 'satellite',
	    disableDefaultUI: true,
		zoomControl: true,
		mapTypeControl: true,
		scaleControl: false,
		streetViewControl: false,
		rotateControl: false
      });
      
      map.setTilt(0);
  
      var infoWindow = new google.maps.InfoWindow;

      var centerControlDiv = document.createElement('div');
        var centerControl = new CenterControl(centerControlDiv, map);

        centerControlDiv.index = 1;
        map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(centerControlDiv);      
        

      var mapControlDiv = document.createElement('div');
        var mapControl = new MapControl(mapControlDiv, map);

        mapControlDiv.index = 1;
        map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(mapControlDiv);      



  // console.log("Set current location marker...");  
	var marker = new google.maps.Marker({
		position: myLatLng,
		map: map,
		title: 'Current location',
		label: '',
		icon: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png'
	});
    bindInfoWindow(marker, map, infoWindow, "<b>Current location</b><br/>" + lat + ", " + lng);
    infoWindow.setContent("<b>Current location</b><br/>" + lat + ", " + lng);
    infoWindow.open(map, marker);
	  // console.log(map);
	  
      // Change this depending on the name of your PHP file
      downloadUrl("locationstoxml.php", function(data) {
        var xml = data.responseXML;
        console.log(xml);
        var markers = xml.documentElement.getElementsByTagName("marker");
        for (var i = 0; i < markers.length; i++) {
          var name = markers[i].getAttribute("name");
          var address = markers[i].getAttribute("address");
          var type = markers[i].getAttribute("type");
          var capType = toTitleCase(type);
          var lat = markers[i].getAttribute("lat");
          var lng = markers[i].getAttribute("lng");
          var icon = customIcons[type] || {};
          // console.log("Location: " + i + "    " + name + "    " + lat + ", " + lng);
          // console.log(icon);
          var point = new google.maps.LatLng(
              parseFloat(lat),
              parseFloat(lng));
//          var html = "<b>" + name + "</b> <br/>" + address + "<br/><input type='button' value='Delete entry' onclick='deleteData(deleteRecord)'/>";
          var html = "<table><tr><td><b>Description</b></td><td>" + name + "</td></tr><tr><td><b>Fruit Type</b></td><td>" + capType + "</td><td><img src='" + icon.icon + "' ></td></tr><tr><td><b>Location</b></td><td>" + address + "</td></tr><tr><td><br /><input type='button' value='Report issue' onclick='reportError()'/></td></tr></table>";

          
          // console.log("Create marker " + i);
          var marker = new google.maps.Marker({
            map: map,
            position: point,
            icon: icon.icon
          });
//          bindInfoWindow(marker, map, infoWindow, html, deleteRecord);
          // console.log("Bind info window");
          bindInfoWindow(marker, map, infoWindow, html);

        }
      });
}

//    function deleteData(deleteRecord) {
//      marker.setVisible(false); 
//	  // console.log(deleteRecord);
//      var address = escape(document.getElementById("address").value);
//      var type = document.getElementById("type").value;
//      var latlng = marker.getPosition();

//      var url = "addrecord.php?name=" + name + "&address=" + address +
//                "&type=" + type + "&lat=" + latlng.lat() + "&lng=" + latlng.lng();
//      downloadUrl(url, function(data, responseCode) {
//        if (responseCode == 200) {
//          infowindow.close();
//          document.getElementById("message").innerHTML = "Location added.";
//		  timeDelay();
//		  }
//      });
//    }

//	function bindInfoWindow(marker, map, infoWindow, html, deleteRecord) {
    function bindInfoWindow(marker, map, infoWindow, html) {
      google.maps.event.addListener(marker, 'click', function() {
        // console.log("Add marker");
        infoWindow.setContent(html);
        infoWindow.open(map, marker);
      });
    }

    function downloadUrl(url, callback) {
      var request = window.ActiveXObject ?
          new ActiveXObject('Microsoft.XMLHTTP') :
          new XMLHttpRequest;

      request.onreadystatechange = function() {
        if (request.readyState == 4) {
          request.onreadystatechange = doNothing;
          callback(request, request.status);
        }
      };

      request.open('GET', url, true);
      request.send(null);
    }

    function reportError() {
      window.open('https://github.com/chopsuei3/fruitmap/issues');
    }

    function doNothing() {}

  </script>

    <style type="text/css">

      html,body { height: 99%; margin: 0px; padding: 5px; }
      #map { height: 99% }

    </style>
  
  </head>

  <body onload="getLocation()">
<!--	<div style="width:500px; height:500px" id="map"></div> -->
<div id="map"></div>
 <!--   <button onclick="window.location.href='add.html'">Map some fruit</button>
    <button onclick="getLocation()">Recenter map</button> -->
  </body>
</html>